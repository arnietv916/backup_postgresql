PostgreSQL Backup Script (Bash)

Скрипт делает резервные копии PostgreSQL по алгоритму:
1) определяет список баз данных  
2) для каждой базы делает дамп штатным `pg_dump`  
3) сжимает дамп в gzip  
4) проверяет целостность `gzip -t`  
5) переносит только исправные архивы в `/backup/pg` (предполагается отдельный диск)

Особенности:
- лаконичное логирование всех шагов
- корректная обработка ошибок (если шаг упал — следующие шаги для этой БД не выполняются)
- никаких временных файлов после завершения (даже при ошибках)
- в `/backup/pg` остаются только исправные `.gz`

Требования

- Bash
- `psql`, `pg_dump` (PostgreSQL client tools)
- `gzip`, `df`, `mktemp`

Установка 

```bash```
chmod +x backup_postgres.sh

Дефолтные переменные в текущей версии скрипта:

BACKUP_DIR = `/backup/pg`

LOG_FILE = `/var/log/db_backup.log (если нет прав — скрипт автоматически пишет в ./db_backup.log)`

PGHOST = `localhost`

PGPORT = `5432`

PGUSER = `backup_user`

Запуск 

```bash```
./backup_postgres.sh
echo "exit_code=$?"

Коды возврата:

0 — всё успешно
1 — часть баз упала (скрипт отработал корректно, но были ошибки по некоторым БД)
2 — критическая ошибка (нет утилит, недоступен каталог бэкапов, нет прав и т.п.)
3 — мало места (временные файлы или диск бэкапов)
4 — не получен список баз (обычно проблема доступа, пароля)

Проверка результата

Файлы должны появиться в каталоге бэкапов:

ls -lah /backup/pg

Проверка целостности всех архивов:

gzip -t /backup/pg/*.gz && echo "ALL ARCHIVES OK"

Лог:

tail -n 200 /var/log/db_backup.log

Или если нет прав на /var/log:
tail -n 200 ./db_backup.log

Или если вы задавали LOG_FILE:
tail -n 200 "$HOME/db_backup.log"


Проверка отсутствия мусора после работы:

В каталоге бэкапов должны остаться только .gz:

find /backup/pg -type f ! -name '*.gz' -print

Временные каталоги в /tmp после завершения не должны оставаться:

find /tmp -maxdepth 1 -type d -name 'pg_backup_*' -print

Пустой вывод — это нормально (значит всё очищено).
